version: '3'

vars:
  MCBAISE_CRATE: bevy_mcbaise_fantasmagoria
  MCBAISE_WASM_TARGET: wasm32-unknown-unknown
  MCBAISE_WWW_DIR: crates/bevy_Mcbaise_Pale_Regard_Absurdia_Fantasmagoria/www
  MCBAISE_WASM_PROFILE: wasm-release
  MCBAISE_PORT: '5173'

tasks:
  demo:native:
    desc: Run the bevy_burn_human demo natively
    cmds:
      - cargo run -p bevy_burn_human

  install-python-modules:
    desc: Install required Python modules
    cmds:
      - pip install numpy
      - pip install torch
      - pip install roma
      - pip install safetensors
      - pip install anny
      - pip install pyyaml
      - pip install pillow

  export-reference:
    desc: Run the export_reference.py script
    deps:
      - task: install-python-modules
    cmds:
      - python tool/scripts/export_reference.py --output assets/model/fullbody_default.safetensors --seed 1234

  mcbaise:native:
    desc: Run the tube ride demo natively
    cmds:
      - cargo run -p {{.MCBAISE_CRATE}}

  mcbaise:assets:preflight:
    desc: Test native asset auto-download (downloads/extracts if needed, prints paths, exits)
    env:
      MCBAISE_ASSETS_PREFLIGHT: "1"
    cmds:
      - cargo run -p {{.MCBAISE_CRATE}}
  mcbaise:assets:self-test:
    desc: Cross-platform Rust self-test for asset download (forces download, verifies files, restores local assets)
    cmds:
      - cargo run -p {{.MCBAISE_CRATE}} -- --assets-self-test

  mcbaise:native:youtube:
    desc: Alias for mcbaise:native:youtube:fresh
    cmds:
      - task: mcbaise:native:youtube:fresh

  mcbaise:native:youtube:fresh:
    desc: Run native tube ride + sync playback from YouTube via WebDriver (fresh Chrome profile)
    env:
      MCBAISE_NATIVE_YOUTUBE: "1"
      MCBAISE_LAUNCH_WEBDRIVER: "1"
      MCBAISE_CHROME_COOKIES_TXT: '{{default "" .CHROME_COOKIES_TXT}}'
    cmds:
      - cargo run -p {{.MCBAISE_CRATE}} --features native-youtube

  mcbaise:native:youtube:default-profile:
    desc: Run native tube ride + YouTube sync using your default Chrome profile (logged-in cookies)
    env:
      MCBAISE_NATIVE_YOUTUBE: "1"
      MCBAISE_LAUNCH_WEBDRIVER: "1"
      MCBAISE_CHROME_USER_DATA_DIR: '{{.LOCALAPPDATA}}\Google\Chrome\User Data'
      MCBAISE_CHROME_PROFILE_DIR: Default
      MCBAISE_CHROME_COOKIES_TXT: '{{default "" .CHROME_COOKIES_TXT}}'
    cmds:
      - cargo run -p {{.MCBAISE_CRATE}} --features native-youtube

  mcbaise:native:mpv:
    desc: Run native tube ride + sync playback from mpv (YouTube via yt-dlp)
    env:
      MCBAISE_NATIVE_MPV: "1"
      MCBAISE_MPV_URL: '{{default "" .MPV_URL}}'
      MCBAISE_MPV_PATH: '{{default "" .MPV_PATH}}'
      MCBAISE_MPV_EXTRA_ARGS: '{{default "" .MPV_EXTRA_ARGS}}'
      MCBAISE_MPV_COOKIES_FILE: '{{default "" .MPV_COOKIES_FILE}}'
      MCBAISE_MPV_COOKIES_FROM_BROWSER: '{{default "" .MPV_COOKIES_FROM_BROWSER}}'
      MCBAISE_MPV_YTDL_RAW_OPTIONS: '{{default "" .MPV_YTDL_RAW_OPTIONS}}'
    cmds:
      - cargo run -p {{.MCBAISE_CRATE}} --features native-mpv

  mcbaise:wasm:toolchain:
    desc: Ensure Rust wasm target is installed
    cmds:
      - rustup target add {{.MCBAISE_WASM_TARGET}}

  mcbaise:wasm:bindgen:install:
    desc: Install wasm-bindgen-cli if missing
    status:
      - wasm-bindgen --version
    cmds:
      - cargo install wasm-bindgen-cli --locked

  mcbaise:wasm:build:
    desc: Build the tube ride demo for wasm and generate wasm-bindgen package into www/pkg
    deps:
      - task: mcbaise:wasm:toolchain
      - task: mcbaise:wasm:bindgen:install
    cmds:
      - cargo build -p {{.MCBAISE_CRATE}} --profile {{.MCBAISE_WASM_PROFILE}} --target {{.MCBAISE_WASM_TARGET}}
      - wasm-bindgen --target web --no-typescript --out-dir {{.MCBAISE_WWW_DIR}}/pkg --out-name {{.MCBAISE_CRATE}} target/{{.MCBAISE_WASM_TARGET}}/{{.MCBAISE_WASM_PROFILE}}/{{.MCBAISE_CRATE}}.wasm

  mcbaise:wasm:serve:
    desc: Serve the repo root so /assets is available, then open the web demo URL manually
    deps:
      - task: mcbaise:wasm:build
    cmds:
      - |
        echo Serve started. Open:
        echo http://localhost:{{.MCBAISE_PORT}}/{{.MCBAISE_WWW_DIR}}/
        python -m http.server {{.MCBAISE_PORT}} || py -m http.server {{.MCBAISE_PORT}}